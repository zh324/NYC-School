<html>
<head>

<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700,900" rel="stylesheet">

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="tip.js"></script>
<link rel="shortcut icon" href="">

<script src="liquidFillGauge.js" type="text/javascript"></script>

 <!-- <script src="liquidFillGauge.js"></script> -->

<script>

var aitoff = d3.geoAitoff();

</script>

<style>
body {
    font-family: 'Roboto', Calibri, sans-serif;

}

.background {
  fill: rgb(255, 255, 255);
  pointer-events: all;
}

.map-layer {
  fill: rgb(184, 179, 179);
  stroke: rgb(61, 60, 60);
  stroke-width: 0.5;
  stroke-opacity: 0.8;
}
.feature {
  /* fill: #ccc; */
  cursor: pointer;
}

.feature.active {
  fill: orange;
}

/* svg { border: solid #ccc 1px; } */

#states {
  fill: #aaa;
}

circle{
    cursor: pointer;
}

path.slice{
	stroke-width:2px;
}

polyline{
	opacity: .3;
	stroke: black;
	stroke-width: 2px;
	fill: none;
}

#mainMap{
    float: left;
}

#chart{
    float: left;
}




.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}


.liquidFillGaugeText { font-family: Helvetica; font-weight: bold; }



</style>
</head>
<body>

<div id="mainMap">
<svg id="p1"></svg>
</div>

<!-- new added -->
<div id="distInfo"></div>
<div id="schoolInfo"></div>
<div id="liquid">

		<svg id="fillgauge1" width="150" height="150"></svg>
        <svg id="fillgauge2" width="150" height="150"></svg>
        <svg id="fillgauge3" width="150" height="150"></svg>

</div>
<div id="chart"></div>
<div id="pie"></div>

<!-- <button class="randomize">randomize</button> -->



<script>

var stats;
var districts;
var features;

d3.csv("Data.csv", function(error, datum) {
  stats = datum;

  districts = d3.nest()
  .key(function(d) { return d.district; })
  .entries(datum);

  var colorScale = d3.scaleLinear()
  .domain([350,550])
  .range(['#fff', "#409A99"])

  d3.json('school_districts.geo.json', function(error, mapData) {
      if (error) throw error;
      var data = mapData;
      features = data.features;

      var width = 700,
      height = 700,
      centered,
      active = d3.select(null);
      var margin = { top: 30, right: 30, bottom: 40, left: 50}



      var projection = d3.geoMercator()
      .fitSize([width * 0.9 ,height], data)
      .fitExtent([[200, 50], [width, height-50]],data)
      // Center the Map in Colombia

      var povertyScale = d3.scaleLinear()
      .domain([0, 100])
      .range([1, 10])

      var path = d3.geoPath()
      .projection(projection);

      var svg = d3.select('#p1')
      .attr('width', width)
      .attr('height', height)
      .on("click", stopped, true);


      var g = svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)
      .on("click", reset);
        //.attr("id", "states")

      var maplayer = svg.append('g')
      .classed('map-layer', true);


      var zoom = d3.zoom()
      // no longer in d3 v4 - zoom initialises with zoomIdentity, so it's already at origin
      // .translate([0, 0])
      // .scale(1)
      .scaleExtent([1, 8])
      .on("zoom", zoomed);




       // Liquid Guage

    
        var gauge1 = d3.select("#fillgauge1");
		
        gauge1
		.call(d3.liquidfillgauge, 455,{
            minValue: 200,
            maxValue: 800,
            displayPercent: false
        })
		.style("padding-left",margin.left);
		
		
    

        var gauge2 = d3.select("#fillgauge2");
        gauge2.call(d3.liquidfillgauge, 440,{
            minValue: 200,
            maxValue: 800,
            displayPercent: false
        })
		.style("padding-left","25");
       

        var gauge3 = d3.select("#fillgauge3");
        gauge3.call(d3.liquidfillgauge, 425,{
            minValue: 200,
            maxValue: 800,
            displayPercent: false
        })
		.style("padding-left","25");
        


        


        // PIE CHART
        //
        //yScale = d3.scaleLinear()
        //            .domain([0, d3.max(bardata)])
        //            .range([0, height_2])
        //
        //xScale = d3.scaleBand()
        //            .domain(d3.range(0,bardata.length*.8))
        //            .rangeRound([0,width_2])
        //            .padding(0.3)

        var width_3 = 400,
        height_3 = 200,
        radius = Math.min(width_3, height_3) / 2;

        var piechart = d3.select("#pie")
        .append("svg")
		.attr("id","pies")
        .attr('width', width_3 + margin.left + margin.left + margin.right + margin.right)
        .attr('height', height_3 + margin.top + margin.top + margin.bottom + margin.bottom + margin.bottom)
        .append("g");


        piechart.append("g")
            .attr("class", "slices")
			.attr("transform", "translate(0,30)");
        piechart.append("g")
            .attr("class", "labels")
			.attr("transform", "translate(0,30)");
        piechart.append("g")
            .attr("class", "lines")
			.attr("transform", "translate(0,30)");

		var pieText = d3.select("#pies")

		pieText.append("text")
        .attr("x",margin.left)
        .attr("y",15)
        .attr("font-size", "20px")
        .attr("font-weight", "400")
        .style("fill", "#000000")
        .text("Demographics")
		.style("opacity","1");


        var pie = d3.pie()
            .sort(null)
            .value(function(d) {
                return d.value;
        });

        var arc = d3.arc()
            .outerRadius(radius * 0.8)
            .innerRadius(radius * 0.4);

        var outerArc = d3.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);



        piechart.attr("transform", "translate(" + width_3 / 2 + "," + height_3 / 2 + ")");

        var key = function(d){ return d.data.label; };

        var color_pie = d3.scaleOrdinal()
        .domain(["White", "Hispanic", "Black", "Asian", "Other"])
        .range(["#386035", "#54AA4C", "#80CC78", "#BCFCB5", "#EAFFE8"]);


        console.log('run');

        function generatePie(){
            console.log('ok');
            change(randomData());
        }

        generatePie();
        generatePie();


        // d3.select(".randomize")
        //     .on("click", function(){
        //         generatePie();
        // });

        function randomData (){
            var labels = color_pie.domain();
            return labels.map(function(label){
                return { label: label, value: Math.random() }
            });
        }




        function change(data) {
     
        /* ------- PIE SLICES -------*/
        var slice = piechart.select(".slices").selectAll("path.slice")
            .data(pie(data), key);
        console.log(data);
        console.log(pie(data));
        

        slice.enter()
            .insert("path")
            .style("fill", function(d) { return color_pie(d.data.label); })
            .attr("class", "slice");

        slice
            .transition().duration(750)
            .attrTween("d", function(d) {
                this._current = this._current || d;
                var interpolate = d3.interpolate(this._current, d);
                this._current = interpolate(0);
                return function(t) {
                    return arc(interpolate(t));
                };
            })

        slice.exit()
            .remove();

        /* ------- TEXT LABELS -------*/

        var text = piechart.select(".labels").selectAll("text")
            .data(pie(data), key);

        text.enter()
            .append("text")
            .attr("dy", ".35em")
			.attr("font-size","12px")
			.attr("font-weight","300")
            .text(function(d) {
                return d.data.label;
            });

        function midAngle(d){
            return d.startAngle + (d.endAngle - d.startAngle)/2;
        }

        text.transition().duration(750)
            .attrTween("transform", function(d) {
                this._current = this._current || d;
                var interpolate = d3.interpolate(this._current, d);
                this._current = interpolate(0);
                return function(t) {
                    var d2 = interpolate(t);
                    var pos = outerArc.centroid(d2);
                    pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
                    return "translate("+ pos +")";
                };
            })
            .styleTween("text-anchor", function(d){
                this._current = this._current || d;
                var interpolate = d3.interpolate(this._current, d);
                this._current = interpolate(0);
                return function(t) {
                    var d2 = interpolate(t);
                    return midAngle(d2) < Math.PI ? "start":"end";
                };
            });

        text.exit()
            .remove();

        /* ------- SLICE TO TEXT POLYLINES -------*/

        var polyline = piechart.select(".lines").selectAll("polyline")
            .data(pie(data), key);

        polyline.enter()
            .append("polyline");

        polyline.transition().duration(1000)
            .attrTween("points", function(d){
                this._current = this._current || d;
                var interpolate = d3.interpolate(this._current, d);
                this._current = interpolate(0);
                return function(t) {
                    var d2 = interpolate(t);
                    var pos = outerArc.centroid(d2);
                    pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
                    return [arc.centroid(d2), outerArc.centroid(d2), pos];
                };
            });

        polyline.exit()
            .remove();
        };




      function zoomed() {
      maplayer.style("stroke-width", 0.5 / d3.event.transform.k + "px");
      // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
      maplayer.attr("transform", d3.event.transform); // updated for d3 v4
      	  
	  }

      function reset() {
      active.classed("active", false);
      active = d3.select(null);

      svg.transition()
          .duration(300)
          // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
          .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
      }

      maplayer.selectAll('path')
        .data(features)
        .enter()
        .append('path')
        .attr('d', path)
        //.attr('vector-effect', 'non-scaling-stroke')
        .attr("class","feature")
        .style('fill', d => colorScale(districts[d.properties.SchoolDist - 1].values[0].district_SAT_Avg))
        .style('stroke', '#141414')
        .style('stroke-width', 0.5)
        .on('mouseover', mouseover)
        .on('mouseout',mouseout)
        .on('click', clicked);

	var schoolInfo = d3.select('#schoolInfo').append('svg')
        .style('background', 'white')
        .attr("id", "bar")
        .attr('width', "600")
        .attr('height', "100");

      var mapCircles = maplayer.selectAll("circle")
        .data(stats)
        .enter()
        .append("circle")
        .attr('fill', '#FFFFFF')
        .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
        .attr("cy", d => projection([d.Longitude, d.Latitude])[1])
        .attr("r", 2.5)
        //.attr("stroke", "url(#svgGradient)")
        //.attr("stroke", "gray")
        //.attr("stroke-width", "0.5px")
//        .on('click', function (d){
//			clicked_circle(d);
//            generatePie(d);
//            generateGauge(d);
//			d3.selectAll("#Title")
//			.style("display","none");
//			
//		schoolInfo.append("text")
//	    .attr("x", margin.left)
//        .attr("y", 30)
//        .attr("font-size", "20px")
//		.attr("font-weight", "700")
//        .style("fill", "#000000")
//        .text("Name of school");
//
//			})
		.on('mouseover', function(d){d3.select(this).style('fill', '#494949');})
		.on('mouseout', function(d){
			d3.select(this).style('fill',"white")
			})

      function mouseover(d){
      // Highlight hovered province
      d3.select(this).style('fill', '#494949');
      }

      function mouseout(d){
      // Reset school district color
      d3.select(this).style('fill', d => colorScale(districts[d.properties.SchoolDist - 1].values[0].district_SAT_Avg));
      }
	  
	var distInfo = d3.select('#distInfo').append('svg')
        .style('background', 'white')
        .attr("id", "bar")
        .attr('width', "600")
        .attr('height', "190")

		
      function clicked(d) {

      if (active.node() === this) return reset();
      active.classed("active", false);
      active = d3.select(this).classed("active", true);


      console.log(d.properties.SchoolDist);
	  
	  var distNum = d.properties.SchoolDist;
	
	distAvgMap = d3.nest()
	.key(function (d) { return d.district; })
	.entries(stats);
	console.log("features")
	console.log(features)
	console.log("distAvgMap");
	console.log(distAvgMap);
	currentDist = distAvgMap[distNum-1];
	console.log("current dist");
	console.log(currentDist);
	console.log(currentDist.values[0].district_SAT_Math_Avg);
	console.log(currentDist.values[0].district_SAT_Reading_Avg);
	console.log(currentDist.values[0].district_SAT_Writing_Avg);
	
	totalAvg = Number(currentDist.values[0].district_SAT_Math_Avg)+Number(currentDist.values[0].district_SAT_Reading_Avg)+Number(currentDist.values[0].district_SAT_Writing_Avg);
	numberOfSchools = distAvgMap[distNum-1].values.length
	
	console.log(distAvgMap)


	mapCircles
        .on('click', function (d){
		var schoolName = d["School Name"];
			
			console.log(d);
			console.log("circled");
			clicked_circle(d);
			
            generatePie(d);
            generateGauge(d);
			d3.selectAll("#Title")
			.style("display","none");

		schoolInfo.append("text")
		.attr("id","nSchool")
	    .attr("x", margin.left)
        .attr("y", 30)
        .attr("font-size", "20px")
		.attr("font-weight", "700")
        .style("fill", "#000000")
        .text(schoolName);

			})
		
      var bounds = path.bounds(d),
          dx = bounds[1][0] - bounds[0][0],
          dy = bounds[1][1] - bounds[0][1],
          x = (bounds[0][0] + bounds[1][0]) / 2,
          y = (bounds[0][1] + bounds[1][1]) / 2,
          scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
          translate = [width / 2 - scale * x, height / 2 - scale * y];

      svg.transition()
          .duration(750)
          //.call(zoom.translate(translate).scale(scale).event); // not in d3 v4
          .call(zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) ); // updated for d3 v4
          //.attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + scale + ')translate(' + -dx + ',' + -dy + ')');

		//set remove text here
		d3.selectAll("#Title")
		//.style("opacity","0")
		.style("display","none");

	distInfo.append("text")
		.attr("id","distInfo1")
	    .attr("x", margin.left)
        .attr("y", 100)
        .attr("font-size", "30px")
		.attr("font-weight", "900")
        .style("fill", "#000000")
        .text("School District: #"+distNum);

	distInfo.append("text")
		.attr("id","distInfo1")
	    .attr("x", margin.left)
        .attr("y", 130)
        .attr("font-size", "25px")
		.attr("font-weight", "700")
        .style("fill", "#000000")
        .text("Avg SAT Score: "+totalAvg);

	distInfo.append("text")
		.attr("id","distInfo1")
		.attr("x", margin.left)
        .attr("y", 160)
        .attr("font-size", "25px")
		.attr("font-weight", "700")
        .style("fill", "#000000")
        .text("Number of Schools: "+numberOfSchools);

      }


      function stopped() {
      if (d3.event.defaultPrevented) {
		d3.event.stopPropagation();
		}
	  
		console.log("stopped");

		d3.selectAll("#distInfo1")
		.style("opacity","0.0");


		d3.selectAll("#Title")
	//.style("opacity","1.0")
		.style("display","block")
	;
	  	
	  
	  
	  
      }



      // ADD TEXT


      svg.append("text")
		.attr("id","Title")
        .attr("x", 45)
        .attr("y", 100+20)
        .attr("font-size", "150px")
        .attr("font-weight", "900")
        .style("fill", "#000000")
		.style("letter-spacing", "10")
        .text("NYC");

      svg.append("text")
		.attr("id","Title")
        .attr("x", 50)
        .attr("y", 100+50+20)
        .attr("font-size", "50px")
        .attr("font-weight", "900")
        .style("fill", "#000000")
        .text("Public Schools");
	
	svg.append("text")
        .attr("id","Title")
		.attr("x", 50)
        .attr("y", 100+25+50+25)
        .attr("font-size", "18px")
        .style("fill", "#000000")
        .text("SAT Scores | Poverty Rates | Demographics");
//
//        svg.append("text")
//		.attr("id","Title")
//        .attr("x", 50)
//        .attr("y", 100+50+50)
//        .attr("font-size", "20px")
//        .style("fill", "#000000")
//        .text("Poverty Rates & Demographics");

            // for (var i=0; i<50; i++){
            //     bardata.push(Math.round(Math.random()*30))
            // }

            // bardata.sort(function compareNumbers(a,b){
            //     return a-b;
            // })

		schoolInfo.append("line")
		.attr("stroke","#2d2d2d")
		.attr("stroke-width", 2)
		.style("stroke-dasharray", "4,4")
		.attr("x1", margin.left)
		.attr("y1", 0)
		.attr("x2", 600)
		.attr("y2", 0);


        // BAR CHART

        var height_2 = 200 - margin.top - margin.bottom,
            width_2 = 250 - margin.right - margin.left,
            barWidth = 50,
            barOffset = 5;

        var tempColor;

        var tooltip = d3.select('#chart').append('div')
                    .style('position', 'absolute')
                    .style('padding', '0 10px')
                    .style('background', 'white')
                    .style('opacity', 0)

        var tip = d3.tip()
                .attr('class', 'd3-tip')
                //.offset([-10,0])
                .html(function(d){
                    //return "<strong>Frequency:</strong> <span style='color:red'>" + d.SAT_Math + "</span> <br />";
                    return d;
                })


        var myChart = d3.select('#chart').append('svg')
        .style('background', 'white')
        .attr("id", "bar")
        .attr('width', width_2 + margin.left + margin.right)
        .attr('height', height_2 + margin.top + margin.bottom)

        
        myChart.call(tip);
        //console.log(xScale);

        var allbars = myChart.append('g')
                    .attr('transform','translate(' + margin.left+','+ margin.top + ')')
                    .attr('id', 'gbars')

        var bardata = [410, 406, 381];

        var xScale;
        var yScale;


        updateBar(bardata);


        // var vGuideScale = d3.scaleLinear()
        //                 .domain([0, d3.max(bardata)])
        //                 .range([height_2, 0])

        // var vAxis = d3.axisLeft(vGuideScale)
        //             //.scale(vGuideScale)
        //             .ticks(10)

        // var vGuide = d3.select('#bar').append('g')
        //     vAxis(vGuide)

        //     vGuide.attr('transform','translate('+margin.left+',' + margin.top + ')')
        //     vGuide.selectAll('path')
        //         .style({fill: 'none', stroke: '#000'})
        //     vGuide.selectAll('line')
        //         .style({stroke: '#000'})

        // var hAxis = d3.axisBottom(xScale)
        //         //.scale(xScale)
        //         .tickValues(xScale.domain().filter(function(d,i){
        //                 return !(i % (bardata.length/5));
        //             }))

        // var hGuide = d3.select('#bar').append('g')
        //             hAxis(hGuide)
        //     hGuide.attr('transform', 'translate('+margin.left+',' + (height_2 + margin.top)                            + ')')
        //     hGuide.selectAll('path')
        //         .style({fill: 'none', stroke: '#000'})
        //     hGuide.selectAll('line')
        //         .style({stroke: '#000'})




        function updateBar(bardata){


        yScale = d3.scaleLinear()
                    .domain([0, d3.max(bardata)])
                    .range([0, height_2])

        xScale = d3.scaleBand()
                    .domain(d3.range(0,bardata.length*.8))
                    .rangeRound([0,width_2])
                    .padding(0.3)

//        var color =
//		d3.scaleLinear()
//                    .domain([0, bardata.length*.63, bardata.length])
//                    .range(['#ffb832','#c61c6f','#d33682'])


//        var rectan = allbars.selectAll('rect')
//                    .data(bardata);
//
//        var allrec = rectan.enter()
//                    .append('rect')
//                    .merge(rectan)
//                    .style('fill', "#409A99"
//						   //function(d,i){
//                            //return color(i);}
//							)
//                    .attr('width', xScale.bandwidth())
//                    .attr('x', function(d,i){
//                            return xScale(i);
//                        })
//                    .attr('height', 0)
//                    .attr('y', height_2)
//
//					//console.log(xScale.bandwidth())
//                    
//                    .on ('mouseover', tip.show)
//                    .on ('mouseout', tip.hide)
//                    //.on('mouseover', function(d){
//                    //    tooltip.transition()
//                    //        .style('opacity', 0.9)
//                    //    tooltip.html(d)
//                    //            .style('left', (d3.event.pageX - 35)+'px')
//                    //            .style('top', (d3.event.pageY - 40)+'px')
//                    //
//                    //
//                    //tempColor = this.style.fill;
//                    //d3.select(this)
//                    //    .style('opacity', .5)
//                    //    .style('fill', 'yellow')
//                    //})
//                    //.on('mouseout', function(d){
//                    //d3.select(this)
//                    //        .style('opacity', 1)
//                    //        .style('fill', tempColor)
//                    //})
//
//                    allrec.transition()
//                            .attr('height', function(d){
//                                    return yScale(d);
//                    })
//                            .attr('y', function(d){
//                                    return height_2 - yScale(d);
//                    })
//                    .delay(function(d,i){
//                            return i*20;
//                    })
//                    .duration(5000)
//                    .ease(d3.easeElastic)
//
//        // remove old data
//        rectan.exit().remove();

        }






        function clicked_circle(d) {
			d3.selectAll("#nSchool")
			.style("display","none");


            bardata = [d.SAT_Math, d.SAT_Reading, d.SAT_Writing];
			updateBar(bardata);
			
        }

        function generateGauge(d){
            gauge1.on("valueChanged")(d.SAT_Math);
            gauge2.on("valueChanged")(d.SAT_Reading);
            gauge3.on("valueChanged")(d.SAT_Writing);
        }





		myChart.append("text")
        .attr("x", margin.left)
        .attr("y", 15)
        .attr("font-size", "20px")
		.attr("font-weight", "400")
        .style("fill", "#000000")
        .text("SAT Scores");

		myChart.append("text")
		.attr("x", margin.left+25)
		.attr("y", 180)
        .attr("font-size", "12px")
		.attr("font-weight", "300")
        .style("fill", "#000000")
        .text("(M)");

		myChart.append("text")
		.attr("x", margin.left+36*2+4)
		.attr("y", 180)
        .attr("font-size", "12px")
		.attr("font-weight", "300")
        .style("fill", "#000000")
        .text("(R)");

		myChart.append("text")
		.attr("x", margin.left+36*3+18)
		.attr("y", 180)
        .attr("font-size", "12px")
		.attr("font-weight", "300")
        .style("fill", "#000000")
        .text("(W)");


  });

});








</script>

</body>
</html>
